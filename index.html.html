<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>3Dスイカゲーム（スマホ対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    canvas { display: block; }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 18px;
      font-family: sans-serif;
      z-index: 1;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="score">スコア: 0</div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
  <script>
    let scene = new THREE.Scene()
    let camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)
    let renderer = new THREE.WebGLRenderer({ antialias: true })
    renderer.setSize(window.innerWidth, window.innerHeight)
    document.body.appendChild(renderer.domElement)

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight
      camera.updateProjectionMatrix()
      renderer.setSize(window.innerWidth, window.innerHeight)
    })

    let world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82, 0) })

    let groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() })
    groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0)
    world.addBody(groundBody)

    let groundMaterial = new THREE.MeshBasicMaterial({ color: 0x333333 })
    let groundGeometry = new THREE.PlaneGeometry(100, 100)
    let groundMesh = new THREE.Mesh(groundGeometry, groundMaterial)
    groundMesh.rotation.x = -Math.PI / 2
    scene.add(groundMesh)

    let light = new THREE.DirectionalLight(0xffffff, 1)
    light.position.set(5, 10, 7.5)
    scene.add(light)

    const fruitData = [
      { radius: 0.5, color: 0xff4444 },
      { radius: 0.8, color: 0xff8844 },
      { radius: 1.0, color: 0xffff44 },
      { radius: 1.3, color: 0x88ff44 },
      { radius: 1.6, color: 0x44ff88 },
      { radius: 2.0, color: 0x4488ff },
      { radius: 2.4, color: 0xaa44ff },
    ]

    let fruitBodies = [], fruitMeshes = []
    let score = 0

    function spawnFruit(x = 0) {
      const level = Math.floor(Math.random() * 3)
      const { radius, color } = fruitData[level]

      let geometry = new THREE.SphereGeometry(radius, 32, 32)
      let material = new THREE.MeshStandardMaterial({ color })
      let mesh = new THREE.Mesh(geometry, material)
      mesh.position.set(x, 10, 0)
      scene.add(mesh)

      let shape = new CANNON.Sphere(radius)
      let body = new CANNON.Body({ mass: radius, shape })
      body.position.set(x, 10, 0)
      world.addBody(body)

      fruitMeshes.push(mesh)
      fruitBodies.push(body)

      createParticle(mesh.position, color)
    }

    function updateScore() {
      document.getElementById('score').textContent = `スコア: ${score}`
    }

    function createParticle(position, color) {
      const count = 20
      for (let i = 0; i < count; i++) {
        const size = 0.05 + Math.random() * 0.05
        const geom = new THREE.SphereGeometry(size, 8, 8)
        const mat = new THREE.MeshStandardMaterial({ color: color, emissive: color, transparent: true, opacity: 0.8 })
        const particle = new THREE.Mesh(geom, mat)
        particle.position.copy(position)
        scene.add(particle)

        const velocity = new THREE.Vector3(
          (Math.random() - 0.5) * 2,
          Math.random() * 2,
          (Math.random() - 0.5) * 2
        )

        let life = 60
        const animateParticle = () => {
          if (life-- > 0) {
            particle.position.add(velocity)
            particle.material.opacity *= 0.95
            requestAnimationFrame(animateParticle)
          } else {
            scene.remove(particle)
          }
        }
        animateParticle()
      }
    }

    // PCクリック or スマホタップ
    function handleInput(event) {
      let clientX = event.clientX || (event.touches && event.touches[0].clientX) || window.innerWidth / 2
      let x = (clientX / window.innerWidth - 0.5) * 10
      spawnFruit(x)
    }

    window.addEventListener('click', handleInput)
    window.addEventListener('touchstart', handleInput)

    camera.position.z = 15
    camera.position.y = 5
    camera.lookAt(0, 0, 0)

    function animate() {
      requestAnimationFrame(animate)
      world.step(1/60)
      for (let i = 0; i < fruitBodies.length; i++) {
        fruitMeshes[i].position.copy(fruitBodies[i].position)
        fruitMeshes[i].quaternion.copy(fruitBodies[i].quaternion)
      }
      renderer.render(scene, camera)
    }

    animate()
  </script>
</body>
</html>
